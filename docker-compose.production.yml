# ============================================================================
# Portal Frontend Production Deployment (Independent)
# ============================================================================
# This docker-compose file deploys the Portal Frontend as a standalone service
# with its own NGINX gateway and SSL certificate management.
#
# Domains: kemetra.org, www.kemetra.org
# Ports: 127.0.0.1:8003 (HTTP), 127.0.0.1:8446 (HTTPS)
# ============================================================================

version: '3.8'

services:
  # Portal Frontend (Next.js Standalone)
  portal-frontend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: portal-frontend
    env_file:
      - .env.production
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-https://api.kemetra.org/api/v1}
    networks:
      - portal-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          memory: 512M
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:3000/']
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  # NGINX Gateway
  nginx:
    image: nginx:1.27-alpine
    container_name: portal-nginx
    env_file:
      - .env.production
    ports:
      - '0.0.0.0:8003:80'      # HTTP - all interfaces
      - '0.0.0.0:8446:443'     # HTTPS - all interfaces
    volumes:
      - ./nginx-configs/kemetra.org.conf:/etc/nginx/conf.d/default.conf:ro
      - ./certs:/etc/letsencrypt:ro
      - ./certbot-www:/var/www/certbot:ro
    depends_on:
      - portal-frontend
    networks:
      - portal-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          memory: 128M
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost/']
      interval: 30s
      timeout: 3s
      retries: 3
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  # Certbot for SSL Certificate Management
  certbot:
    image: certbot/certbot:latest
    container_name: portal-certbot
    volumes:
      - ./certs:/etc/letsencrypt
      - ./certbot-www:/var/www/certbot
    networks:
      - portal-network
    # For initial setup, run:
    # docker compose -f docker-compose.production.yml run --rm certbot \
    #   certonly --webroot --webroot-path=/var/www/certbot \
    #   --email admin@kemetra.org --agree-tos --no-eff-email \
    #   -d kemetra.org -d www.kemetra.org
    command: renew --webroot --webroot-path=/var/www/certbot
    profiles:
      - ssl-setup
      - ssl-renew

networks:
  portal-network:
    driver: bridge

# ============================================================================
# Deployment Commands:
# ============================================================================
#
# Initial Setup (First Time):
# 1. Create directories:
#    mkdir -p nginx-configs certs certbot-www
#
# 2. Copy nginx config:
#    # Create nginx-configs/kemetra.org.conf
#
# 3. Setup SSL certificates (for both kemetra.org and www.kemetra.org):
#    docker compose down nginx
#    docker compose --profile ssl-setup run --rm certbot certonly \
#      --standalone -d kemetra.org -d www.kemetra.org \
#      --email admin@kemetra.org --agree-tos
#
# 4. Deploy:
#    docker compose up -d
#
# Regular Deployment:
#   docker compose up -d --build
#
# View Logs:
#   docker compose logs -f portal-frontend
#   docker compose logs -f nginx
#
# SSL Renewal (Manual):
#   docker compose --profile ssl-renew run --rm certbot renew
#   docker compose exec nginx nginx -s reload
#
# Stop Services:
#   docker compose down
#
# Complete Cleanup:
#   docker compose down -v
# ============================================================================
